#!/bin/busybox sh

# Exit if an error occurs or an unset variable is referenced.
set -euo pipefail

# Build our `etc/postfix/aliases` file so Postfix can use it.
newaliases

# Create an initial password database for Dovecot.
mkdir -p /etc/auth
touch /etc/auth/passwd

# Only let Dovecot access the password database.
chmod -R 0700 /etc/auth
chown -R dovecot:dovecot /etc/auth

# Create the Postfix TLS chain file directory, and give `acme.sh` access so it
# can output new certificates there. (Postfix outputs warnings due to anyone but
# `root` having access, but the alternative is making a `setuid` `root` program
# that only the `acme-sh` user can execute, just to copy `acme.sh`'s files into
# the directory. There's no reason for that, and in fact that would increase our
# server's attack surface.)
mkdir -p /etc/postfix/smtpd_tls_chain_files
chmod 770 /etc/postfix/smtpd_tls_chain_files
chown root:acme-sh /etc/postfix/smtpd_tls_chain_files

# Run our build script for `acme.sh` as an unprivileged user.
su acme-sh -s /bin/sh -c /home/acme-sh/bin/build

# Delete this script. It only needs to run initially for the Docker image build.
rm "$0"
