#!/bin/busybox sh

# Exit if an error occurs or an unset variable is referenced.
set -euo pipefail

# Checks the SPF DNS record for our hostname.
_check_hostname_spf() {
	printf '%s\n' "Checking SPF..."

	# Get our mail server's hostname (e.g. `mail.example.com`).
	local hostname
	hostname="$(hostname)"

	# The DNS record that should have our SPF policy. This is intentionally
	# not ensured to be under the zone we can access because having access
	# to our source SPF record increases our attack surface needlessly.
	local record_name="$hostname"

	# Fetch the information for the SPF record we're checking. If no such
	# record exists, this will be empty.
	local record_json
	record_json="$(get_spf_record "$record_name")"

	# Get the SPF record's content. If no such record exists, this will be
	# empty.
	local spf_data
	spf_data="$(printf '%s\n' "$record_json" | jq -r '.content')"

	# Start generating the value the SPF record should have.
	local correct_spf_data="v=spf1"

	# Obtain this server's public IP addresses to use in our SPF DNS record.
	# If either request fails, do nothing instead of exiting, because it's
	# expected that some networks don't support both IPv4 and IPv6.
	local ipv4 ipv6
	ipv4="$(curl -s --ipv4 https://icanhazip.com/ || :)"
	ipv6="$(curl -s --ipv6 https://icanhazip.com/ || :)"

	# If no IPs are found, something is wrong, and we won't be able to add
	# this server as an allowed sender in our SPF record.
	if [[ ! "$ipv4$ipv6" ]]; then
		printf '%s\n' "ERROR: Could not obtain your public IP address (to include in your SPF record)." >&2
		return 1
	fi

	# Add our server's IP addresses to our SPF record as allowed senders.
	if [[ "$ipv4" ]]; then
		correct_spf_data="$correct_spf_data ip4:$ipv4"
	fi
	if [[ "$ipv6" ]]; then
		correct_spf_data="$correct_spf_data ip6:$ipv6"
	fi

	# Disallow all other senders. Only our mail server should be able to
	# send as our mail server.
	#
	# Note that, as per RFC 7208 (section 5.2), this has no effect on other
	# SPF records that `include:` this one, which is good for domains that
	# want to allow multiple mail servers including ours to send as them.
	correct_spf_data="$correct_spf_data -all"

	# Fetch our server's existing SPF record. If there is none, this will be
	# empty.
	local record_json
	record_json="$(get_spf_record "$record_name")"

	# Get the SPF record's current value.
	local spf_data
	spf_data="$(printf '%s\n' "$record_json" | jq -r '.content')"

	# Ensure the SPF record is set correctly.
	require_dns_record SPF TXT "$record_name" \
		"$spf_data" "$correct_spf_data" \
		"$record_json"
}

# Checks the DNS records for all the domains of the addresses in our password
# database to ensure we're allowed to send as them.
_check_sender_domains() {
	user domains \
	| while read -r sender_domain; do
		printf '%s\n' "Checking DNS for sender domain '$sender_domain'..."

		check_sender_dns "$sender_domain"
	done
}

_check_hostname_spf
_check_sender_domains
