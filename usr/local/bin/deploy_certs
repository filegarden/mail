#!/bin/busybox sh

# Exit if an error occurs or an unset variable is referenced.
set -euo pipefail

# Create the named pipe we'll use to let our `home/acme/bin/hook` script
# communicate with this script, and give it the necessary permissions to access
# the pipe.
mkfifo -m 0620 /var/run/deploy_certs
chgrp acme /var/run/deploy_certs

# Repeatedly do the following forever.
while true; do
	# Open the below named pipe for reading. This script cannot continue
	# until our ACME hook script opens the pipe for writing, informing us
	# that `dehydrated` has updated our TLS certificates. We don't care
	# about any data written to the pipe, only that it's opened for writing,
	# so discard any data that comes through.
	cat /var/run/deploy_certs > /dev/null

	# Give the updated certificate files to Postfix.
	update_cert_files

	# Reload Postfix so it can use the updated files.
	postfix reload
done
