#!/bin/busybox sh

# Exit if an error occurs or an unset variable is referenced.
set -euo pipefail

# Delete `dehydrated`'s lock file if it was left over from a previous time this
# container ran. Otherwise `dehydrated` will refuse to run.
rm -f /home/acme/dehydrated/lock

# Run our TLS certificate issuing script as the unprivileged `acme` user.
su acme -s /bin/sh -c /home/acme/bin/issue

# Run our DKIM key generation script as the unprivileged `opendkim` user.
su opendkim -s /bin/sh -c /home/opendkim/bin/genkey

# Update our certificate files before starting the mail server since our above
# `home/acme/bin/start` script could have changed them, and the below `nc` TCP
# server that would normally listen for certificate updates to run this hasn't
# started yet, so it could have missed that initial update.
update_cert_files

# Run everything needed for our mail server in parallel, replacing this script's
# shell process (using `exec`) since the shell is no longer needed.
# * If one of the below processes exits, also halt the others so the container
#   can restart.
# * Ensure different lines logged at the same time don't intermingle.
# * Don't limit the number of simultaneous commands to one per CPU thread. All
#   these commands must run unconditionally.
# * Run these commands simultaneously, and in the foreground so `parallel` can
#   detect when they exit and stay open as long as they're open. Running these
#   in the foreground also makes their output appear in the container's output.
#   * `syslogd` is what handles system logs. `-n` runs it in the foreground, and
#     `-O /dev/stdout` tells it to output all logs to the container's output.
#   * The `crond` command runs `cron`, which is for scheduling automatic jobs.
#     We use it to schedule TLS certificate renewal.
#   * Run our `usr/local/bin/deploy_certs` script. Whenever our certificate
#     files update, this gives Postfix the updated files and reloads Postfix.
#   * The other programs listed here are described in our `Dockerfile`.
exec parallel \
    --halt now,done=1 \
    --line-buffer \
    --jobs 0 \
    ::: \
    "syslogd -n -O /dev/stdout" \
    "crond -f" \
    "deploy_certs" \
    "postfix start-fg" \
    "dovecot -F" \
    "opendkim -f"
